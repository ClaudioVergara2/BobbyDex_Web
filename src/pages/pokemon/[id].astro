---
import "../../styles/global.css";

type FlavorEntry = {
  flavor_text: string;
  language: { name: string };
  version: { name: string };
};

type PokemonType = {
  type: { name: string };
};

type Stat = {
  base_stat: number;
  stat: { name: string };
};

export async function getStaticPaths() {
  const res = await fetch("https://pokeapi.co/api/v2/pokemon?limit=1025");
  const data = await res.json();

  return data.results.map((_: any, index: number) => ({
    params: { id: (index + 1).toString() },
  }));
}

const { id } = Astro.params as { id: string };
if (!id) throw new Error("ID de Pokémon no válida");

async function fetchPokemon(id: string) {
  const r = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
  if (!r.ok) throw new Error("Pokémon no encontrado");
  return await r.json();
}

async function fetchSpecies(id: string) {
  const r = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${id}`);
  if (!r.ok) throw new Error("No se pudo obtener la descripción");
  return await r.json();
}

const pokemon = await fetchPokemon(id);
const species = await fetchSpecies(id);

const entry: FlavorEntry | undefined = species.flavor_text_entries.find(
  (t: FlavorEntry) => t.language.name === "es"
);

const description = entry ? entry.flavor_text.replace(/\n|\f/g, " ") : "Sin descripción disponible.";
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>{pokemon.name} — BobbyDex</title>
  </head>
  <body class="bg-black text-white min-h-screen flex items-center justify-center">
    <main class="max-w-xl mx-auto relative pokedex-frame p-6">
      <div class="pokedex-led"></div>
      <div class="pokedex-left-btn"></div>
      <div class="pokedex-right-btn"></div>
      <div class="pokedex-screen p-6 rounded-2xl bg-gray-900 border-4 border-gray-700 shadow-xl">
        <h1 class="text-3xl font-bold text-center text-green-400 capitalize">{pokemon.name}</h1>
        <p class="text-center text-gray-300 text-xl mb-6">#{pokemon.id}</p>
        <div class="flex justify-center mb-6">
          <img src={pokemon.sprites.other["official-artwork"].front_default ?? pokemon.sprites.front_default} alt={pokemon.name} class="w-48 h-48 object-contain drop-shadow-xl transition-transform hover:scale-105"/>
        </div>
        <div class="bg-gray-800 p-4 rounded-xl shadow mb-4">
          <h3 class="text-2xl font-bold mb-2">Descripción</h3>
          <p class="text-gray-300 leading-relaxed">{description}</p>
        </div>
        <div class="bg-gray-800 p-4 rounded-xl shadow mb-4">
          <h3 class="text-2xl font-bold mb-2">Tipo</h3>
          <div class="flex gap-2">
            {pokemon.types.map((t: PokemonType) => (
              <span class="px-3 py-1 bg-gray-700 rounded-full text-white capitalize shadow">{t.type.name}</span>
            ))}
          </div>
        </div>
        <div class="bg-gray-800 p-4 rounded-xl shadow mb-4">
          <h3 class="text-2xl font-bold mb-2">Estadísticas</h3>
          <div class="space-y-3">
            {pokemon.stats.map((s: Stat) => (
              <div>
                <p class="capitalize font-semibold">{s.stat.name}: {s.base_stat}</p>
                <div class="w-full bg-gray-700 rounded h-3 mt-1">
                  <div class="h-3 bg-blue-500 rounded" style={`width: ${Math.min((s.base_stat / 200) * 100, 100)}%`}></div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
      <div class="flex justify-center gap-4 mt-6">
        <div class="w-6 h-6 bg-blue-800 rounded-full border-2 border-black"></div>
        <div class="w-6 h-6 bg-yellow-400 rounded-full border-2 border-black"></div>
        <div class="w-6 h-6 bg-green-500 rounded-full border-2 border-black"></div>
      </div>
    </main>
  </body>
</html>