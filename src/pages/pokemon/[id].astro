---
import "../../styles/global.css";

type FlavorEntry = {
  flavor_text: string;
  language: { name: string };
  version: { name: string };
};

type PokemonType = {
  type: { name: string };
};

type Stat = {
  base_stat: number;
  stat: { name: string };
};

export async function getStaticPaths() {
  const res = await fetch("https://pokeapi.co/api/v2/pokemon?limit=1025");
  const data = await res.json();

  return data.results.map((_: any, index: number) => ({
    params: { id: (index + 1).toString() },
  }));
}

const { id } = Astro.params as { id: string };
if (!id) throw new Error("ID de Pokémon no válida");

async function fetchPokemon(id: string) {
  const r = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
  if (!r.ok) throw new Error("Pokémon no encontrado");
  return await r.json();
}

async function fetchSpecies(id: string) {
  const r = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${id}`);
  if (!r.ok) throw new Error("No se pudo obtener la descripción");
  return await r.json();
}

async function fetchTypeRelations(typeName: string) {
  const r = await fetch(`https://pokeapi.co/api/v2/type/${typeName}`);
  if (!r.ok) return { double_damage_from: [], double_damage_to: [] };
  const data = await r.json();
  return {
    weak: data.damage_relations.double_damage_from.map((t: any) => t.name),
    strong: data.damage_relations.double_damage_to.map((t: any) => t.name),
  };
}

const pokemon = await fetchPokemon(id);
const species = await fetchSpecies(id);

const entry: FlavorEntry | undefined = species.flavor_text_entries.find(
  (t: FlavorEntry) => t.language.name === "es"
);
const description = entry ? entry.flavor_text.replace(/\n|\f/g, " ") : "Sin descripción disponible.";

const typeTranslation: Record<string, string> = {
  normal: "Normal",
  fire: "Fuego",
  water: "Agua",
  electric: "Eléctrico",
  grass: "Planta",
  ice: "Hielo",
  fighting: "Lucha",
  poison: "Veneno",
  ground: "Tierra",
  flying: "Volador",
  psychic: "Psíquico",
  bug: "Bicho",
  rock: "Roca",
  ghost: "Fantasma",
  dragon: "Dragón",
  dark: "Siniestro",
  steel: "Acero",
  fairy: "Hada"
};

const typeColors: Record<string, string> = {
  Volador: "bg-blue-400",
  Veneno: "bg-purple-700",
  Bicho: "bg-green-600",
  Fuego: "bg-red-600",
  Hielo: "bg-cyan-300",
  Tierra: "bg-yellow-700",
  Psíquico: "bg-pink-500",
  Roca: "bg-gray-500",
  Agua: "bg-blue-700",
  Planta: "bg-green-500",
  Hada: "bg-pink-300",
  Normal: "bg-gray-300",
  Lucha: "bg-red-700",
  Fantasma: "bg-indigo-700",
  Dragón: "bg-indigo-500",
  Siniestro: "bg-gray-800",
  Acero: "bg-gray-400",
  Eléctrico: "bg-yellow-400"
};

const statTranslation: Record<string, string> = {
  "hp": "PS",
  "attack": "Ataque",
  "defense": "Defensa",
  "special-attack": "Ataque Especial",
  "special-defense": "Defensa Especial",
  "speed": "Velocidad"
};

const weaknessesSet = new Set<string>();
const strengthsSet = new Set<string>();

for (const t of pokemon.types) {
  const relations = await fetchTypeRelations(t.type.name);
  relations.weak.forEach((w: string) => weaknessesSet.add(typeTranslation[w] || w));
  relations.strong.forEach((s: string) => strengthsSet.add(typeTranslation[s] || s));
}

const weaknesses = Array.from(weaknessesSet);
const strengths = Array.from(strengthsSet);

const evolutionUrl = species.evolution_chain?.url;
let evolutionLine: { id: number; name: string; sprite: string; from?: number; level?: number }[] = [];

if (evolutionUrl) {
  const evoRes = await fetch(evolutionUrl);
  const evoData = await evoRes.json();

  function traverseEvo(chain: any, prevId?: number) {
    const id = parseInt(chain.species.url.split("/")[6]);
    evolutionLine.push({
      id,
      name: chain.species.name,
      sprite: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`,
      from: prevId,
      level: chain.evolution_details?.[0]?.min_level || null
    });

    if (chain.evolves_to.length > 0) {
      chain.evolves_to.forEach((next: any) => traverseEvo(next, id));
    }
  }

  traverseEvo(evoData.chain);
}
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>BobbyDex - {pokemon.name}</title>
  </head>
  <body class="bg-black text-white min-h-screen flex items-center justify-center">
    <main class="max-w-5xl mx-auto relative pokedex-frame p-6">
      <div class="pokedex-led"></div>
      <div class="pokedex-left-btn"></div>
      <div class="pokedex-right-btn"></div>
      <div class="pokedex-screen p-6 rounded-2xl bg-gray-900 border-4 border-gray-700 shadow-xl flex gap-6">
        <div class="flex flex-col items-center justify-start w-1/3">
          <h1 class="text-3xl font-bold text-center text-green-400 capitalize mb-2">{pokemon.name}</h1>
          <p class="text-center text-gray-300 text-xl mb-4 capitalize">
            {pokemon.types.map((t: PokemonType) => typeTranslation[t.type.name] || t.type.name).join(" / ")}
          </p>
          <img src={pokemon.sprites.other["official-artwork"].front_default ?? pokemon.sprites.front_default} alt={pokemon.name} class="w-60 h-60 object-contain drop-shadow-xl transition-transform hover:scale-105 mb-4" />
          <div class="bg-gray-800 p-4 rounded-xl shadow w-full">
            <h3 class="text-2xl font-bold mb-2">Descripción</h3>
            <p class="text-gray-300 leading-relaxed">{description}</p>
          </div>
        </div>
        <div class="flex flex-col gap-4 w-2/3 max-h-[700px] overflow-y-auto pr-2 pokedex-scroll">
          <div class="bg-gray-800 p-4 rounded-xl shadow">
            <h3 class="text-2xl font-bold mb-2">Debilidades</h3>
            <div class="flex flex-wrap gap-2">
              {weaknesses.length === 0 ? (
                <span class="text-gray-300">Ninguna</span>
              ) : (
                weaknesses.map((w) => (
                  <span class={`px-3 py-1 rounded-full capitalize shadow ${typeColors[w] || "bg-gray-600"}`}>{w}</span>
                ))
              )}
            </div>
            <h3 class="text-2xl font-bold mb-2 mt-4">Fortalezas</h3>
            <div class="flex flex-wrap gap-2">
              {strengths.length === 0 ? (
                <span class="text-gray-300">Ninguna</span>
              ) : (
                strengths.map((s) => (
                  <span class={`px-3 py-1 rounded-full capitalize shadow ${typeColors[s] || "bg-gray-600"}`}>{s}</span>
                ))
              )}
            </div>
          </div>
          <div class="bg-gray-800 p-4 rounded-xl shadow">
            <h3 class="text-2xl font-bold mb-2">Estadísticas</h3>
            <div class="space-y-3">
              {pokemon.stats.map((s: Stat) => (
                <div>
                  <p class="capitalize font-semibold">
                    {statTranslation[s.stat.name] || s.stat.name}: {s.base_stat}
                  </p>
                  <div class="w-full bg-gray-700 rounded h-3 mt-1">
                    <div class="h-3 bg-blue-500 rounded" style={`width: ${Math.min((s.base_stat / 200) * 100, 100)}%`}></div>
                  </div>
                </div>
              ))}
            </div>
          </div>
          <div class="bg-gray-800 p-4 rounded-xl shadow mt-4 flex flex-col">
            <h3 class="text-2xl font-bold mb-2">Línea Evolutiva</h3>
            <div class="flex items-center gap-2">
              {evolutionLine.map((p, i) => (
                <>
                  {i > 0 && (
                    <div class="flex flex-col items-center">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M0 12h24M18 6l6 6-6 6" />
                      </svg>
                      {p.level && <span class="text-gray-300 text-sm mt-1">Nivel {p.level}</span>}
                    </div>
                  )}
                  <a href={`/pokemon/${p.id}`} class="flex flex-col items-center min-w-[100px] bg-gray-700 p-2 rounded-xl shadow hover:scale-105 transition">
                    <img src={p.sprite} alt={p.name} class="w-20 h-20 object-contain mb-2"/>
                    <span class="capitalize text-center">{p.name}</span>
                  </a>
                </>
              ))}
            </div>
          </div>
        </div>
      </div>      
      <div class="flex justify-center gap-4 mt-6">
        <button class="pokedex-btn prev-btn">
          <span class="arrow left"></span>
        </button>
        <button class="pokedex-btn home-btn">
          <span class="roof"></span>
          <span class="walls"></span>
        </button>
        <button class="pokedex-btn next-btn">
          <span class="arrow right"></span>
        </button>
      </div>
    </main>
    <script type="module" src="/scripts/buttons.js"></script>
  </body>
</html>