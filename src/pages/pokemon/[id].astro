---
import "../../styles/global.css";

type FlavorEntry = {
  flavor_text: string;
  language: { name: string };
  version: { name: string };
};

type PokemonType = {
  type: { name: string };
};

type Stat = {
  base_stat: number;
  stat: { name: string };
};

export async function getStaticPaths() {
  const res = await fetch("https://pokeapi.co/api/v2/pokemon?limit=1025");
  const data = await res.json();

  const paths = data.results.map((_: any, index: number) => ({
    params: { id: (index + 1).toString() },
  }));

  return paths;
}

const { id } = Astro.params as { id: string };

if (!id) throw new Error("ID de Pokémon no válida");

async function fetchPokemon(id: string) {
  const r = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
  if (!r.ok) throw new Error("Pokémon no encontrado");
  return await r.json();
}

async function fetchSpecies(id: string) {
  const r = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${id}`);
  if (!r.ok) throw new Error("No se pudo obtener la descripción");
  return await r.json();
}

const pokemon = await fetchPokemon(id);
const species = await fetchSpecies(id);

const entry: FlavorEntry | undefined = species.flavor_text_entries.find(
  (t: FlavorEntry) => t.language.name === "es"
);

const description = entry ? entry.flavor_text.replace(/\n|\f/g, " ") : "Sin descripción disponible.";
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>{pokemon.name} — BobbyDex</title>
  </head>
  <body class="bg-gray-900 text-white min-h-screen">
    <nav class="bg-gray-800 p-4 shadow mb-8">
      <h1 class="text-3xl font-bold text-center">BOBBYDEX</h1>
    </nav>
    <main class="max-w-4xl mx-auto p-6">
      <h2 class="text-5xl font-bold text-center mb-4 capitalize">
        {pokemon.name}
      </h2>
      <p class="text-center text-gray-300 text-xl mb-8">
        #{pokemon.id}
      </p>
      <div class="flex justify-center mb-8">
        <img 
          src={pokemon.sprites.other["official-artwork"].front_default ?? pokemon.sprites.front_default}
          alt={pokemon.name}
          class="w-72 h-72 object-contain drop-shadow-xl transition-transform hover:scale-105"
        />
      </div>
      <div class="bg-gray-800 p-6 rounded-xl shadow mb-8">
        <h3 class="text-2xl font-bold mb-2">Descripción</h3>
        <p class="text-gray-300 leading-relaxed">{description}</p>
      </div>
      <div class="bg-gray-800 p-6 rounded-xl shadow mb-8">
        <h3 class="text-2xl font-bold mb-4">Tipo</h3>
        <div class="flex gap-3">
          {pokemon.types.map((t: PokemonType) => (
            <span class="px-4 py-2 bg-gray-700 rounded-full text-white capitalize shadow">
              {t.type.name}
            </span>
          ))}
        </div>
      </div>
      <div class="bg-gray-800 p-6 rounded-xl shadow mb-8">
        <h3 class="text-2xl font-bold mb-4">Estadísticas</h3>
        <div class="space-y-4">
          {pokemon.stats.map((s: Stat) => (
            <div>
              <p class="capitalize font-semibold">{s.stat.name}: {s.base_stat}</p>
              <div class="w-full bg-gray-700 rounded h-3 mt-1">
                <div
                  class="h-3 bg-blue-500 rounded"
                  style={`width: ${Math.min((s.base_stat / 200) * 100, 100)}%`}
                ></div>
              </div>
            </div>
          ))}
        </div>
      </div>
      <div class="text-center mt-10">
        <a href="/generation/1" class="px-6 py-3 bg-gray-700 rounded-xl shadow hover:bg-gray-600 transition">
          ← Volver
        </a>
      </div>
    </main>
  </body>
</html>